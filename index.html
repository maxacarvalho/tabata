<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Tabata">
<title>Tabata Timer</title>
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVGFiYXRhIFRpbWVyIiwic2hvcnRfbmFtZSI6IlRhYmF0YSIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMGEwYTBhIiwidGhlbWVfY29sb3IiOiIjMGEwYTBhIn0=">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0a;
    --work: #FF3B30;
    --rest: #30D158;
    --prepare: #FF9F0A;
    --text: #f5f5f5;
    --muted: #666;
    --surface: #1a1a1a;
    --surface2: #252525;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'JetBrains Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow: hidden;
    -webkit-user-select: none;
    user-select: none;
  }

  .glow {
    position: fixed;
    top: -40%;
    left: 50%;
    transform: translateX(-50%);
    width: 120vw;
    height: 80vh;
    border-radius: 50%;
    filter: blur(100px);
    opacity: 0.15;
    transition: background 0.8s ease;
    pointer-events: none;
    z-index: 0;
  }
  .glow.work { background: var(--work); }
  .glow.rest { background: var(--rest); }
  .glow.prepare { background: var(--prepare); }
  .glow.idle { background: #333; }

  .flash-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
    z-index: 100;
    opacity: 0;
    transition: opacity 0.1s;
  }
  .flash-overlay.active {
    opacity: 1;
    animation: flashFade 0.4s ease-out forwards;
  }
  @keyframes flashFade {
    0% { opacity: 0.6; }
    100% { opacity: 0; }
  }

  .container {
    position: relative;
    z-index: 1;
    width: 100%;
    max-width: 420px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100dvh;
  }

  h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.2rem;
    letter-spacing: 0.15em;
    color: var(--text);
    margin-top: env(safe-area-inset-top, 16px);
    margin-bottom: 8px;
  }

  .phase-label {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.4rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    transition: color 0.4s;
    min-height: 2em;
    display: flex;
    align-items: center;
  }
  .phase-label.work { color: var(--work); }
  .phase-label.rest { color: var(--rest); }
  .phase-label.prepare { color: var(--prepare); }

  .timer-wrap {
    position: relative;
    width: 280px;
    height: 280px;
    margin: 20px 0;
  }

  .timer-ring {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
  }

  .timer-ring-bg {
    fill: none;
    stroke: var(--surface2);
    stroke-width: 8;
  }

  .timer-ring-progress {
    fill: none;
    stroke-width: 8;
    stroke-linecap: round;
    transition: stroke 0.4s ease;
    stroke-dasharray: 816.8;
    stroke-dashoffset: 0;
  }

  .timer-display {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }

  .timer-seconds {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 7rem;
    line-height: 1;
    letter-spacing: 0.05em;
    transition: color 0.4s;
  }

  .timer-ms {
    font-size: 1.2rem;
    color: var(--muted);
    margin-top: -4px;
  }

  .series-info {
    font-size: 1rem;
    color: var(--muted);
    margin-bottom: 24px;
    letter-spacing: 0.1em;
  }
  .series-info span {
    color: var(--text);
    font-weight: 700;
  }

  .controls {
    display: flex;
    gap: 16px;
    margin-bottom: 32px;
  }

  .btn {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.3rem;
    letter-spacing: 0.15em;
    border: none;
    cursor: pointer;
    border-radius: 16px;
    padding: 14px 36px;
    transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  .btn:active { transform: scale(0.95); }

  .btn-primary {
    background: var(--work);
    color: #fff;
  }
  .btn-primary.running {
    background: var(--muted);
  }
  .btn-secondary {
    background: var(--surface2);
    color: var(--text);
  }

  .settings {
    width: 100%;
    background: var(--surface);
    border-radius: 20px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .setting-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .setting-label {
    font-size: 0.85rem;
    color: var(--muted);
    letter-spacing: 0.05em;
  }

  .setting-control {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .setting-btn {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    border: 1px solid var(--surface2);
    background: var(--bg);
    color: var(--text);
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
  }
  .setting-btn:active { background: var(--surface2); }

  .setting-value {
    font-size: 1.1rem;
    font-weight: 700;
    min-width: 40px;
    text-align: center;
  }

  .setting-unit {
    font-size: 0.75rem;
    color: var(--muted);
  }

  .toggle-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 8px;
    border-top: 1px solid var(--surface2);
  }

  .toggle-label-wrap {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .toggle-sublabel {
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.02em;
  }

  .toggle {
    position: relative;
    width: 52px;
    height: 30px;
    flex-shrink: 0;
  }

  .toggle input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-track {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background: var(--surface2);
    border-radius: 15px;
    transition: background 0.3s;
  }

  .toggle-track::before {
    content: '';
    position: absolute;
    height: 24px;
    width: 24px;
    left: 3px;
    bottom: 3px;
    background: var(--text);
    border-radius: 50%;
    transition: transform 0.3s;
  }

  .toggle input:checked + .toggle-track {
    background: var(--rest);
  }

  .toggle input:checked + .toggle-track::before {
    transform: translateX(22px);
  }

  @keyframes countPulse {
    0% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.08); }
    100% { transform: translate(-50%, -50%) scale(1); }
  }
  .timer-display.pulse {
    animation: countPulse 0.3s ease;
  }

  .dots {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--surface2);
    transition: background 0.3s, transform 0.3s;
  }
  .dot.done { background: var(--work); }
  .dot.active { background: var(--work); transform: scale(1.3); box-shadow: 0 0 10px var(--work); }
  .dot.rest-active { background: var(--rest); transform: scale(1.3); box-shadow: 0 0 10px var(--rest); }

  .finished-msg {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.5rem;
    letter-spacing: 0.1em;
    color: var(--work);
    display: none;
  }

  .hint {
    font-size: 0.7rem;
    color: var(--muted);
    text-align: center;
    margin-top: auto;
    padding-bottom: env(safe-area-inset-bottom, 16px);
    line-height: 1.5;
  }

  .wakelock-badge {
    font-size: 0.65rem;
    color: var(--muted);
    background: var(--surface);
    padding: 2px 8px;
    border-radius: 6px;
    margin-bottom: 8px;
    display: none;
  }

  .mode-badge {
    font-size: 0.7rem;
    color: var(--rest);
    background: rgba(48, 209, 88, 0.1);
    border: 1px solid rgba(48, 209, 88, 0.2);
    padding: 3px 10px;
    border-radius: 8px;
    margin-bottom: 4px;
    display: none;
    letter-spacing: 0.05em;
  }
</style>
</head>
<body>

<div class="glow idle" id="glow"></div>
<div class="flash-overlay" id="flashOverlay"></div>

<div class="container">
  <h1>TABATA</h1>
  <div class="wakelock-badge" id="wakeBadge">ðŸ”’ Tela ativa</div>
  <div class="mode-badge" id="modeBadge">â™« MODO MÃšSICA â€” sÃ³ vibraÃ§Ã£o</div>

  <div class="phase-label" id="phaseLabel">&nbsp;</div>

  <div class="timer-wrap">
    <svg class="timer-ring" viewBox="0 0 280 280">
      <circle class="timer-ring-bg" cx="140" cy="140" r="130"/>
      <circle class="timer-ring-progress" id="ringProgress" cx="140" cy="140" r="130"/>
    </svg>
    <div class="timer-display" id="timerDisplay">
      <div class="timer-seconds" id="timerSeconds">20</div>
      <div class="timer-ms" id="timerMs">.00</div>
    </div>
    <div class="finished-msg" id="finishedMsg">COMPLETO!</div>
  </div>

  <div class="dots" id="dots"></div>

  <div class="series-info" id="seriesInfo">
    SÃ©rie <span id="currentSeries">0</span> / <span id="totalSeries">8</span>
  </div>

  <div class="controls">
    <button class="btn btn-primary" id="btnStart">INICIAR</button>
    <button class="btn btn-secondary" id="btnReset" style="display:none">RESET</button>
  </div>

  <div class="settings" id="settings">
    <div class="setting-row">
      <span class="setting-label">SÃ‰RIES</span>
      <div class="setting-control">
        <button class="setting-btn" onclick="adjustSetting('sets', -1)">âˆ’</button>
        <span class="setting-value" id="valSets">8</span>
        <button class="setting-btn" onclick="adjustSetting('sets', 1)">+</button>
      </div>
    </div>
    <div class="setting-row">
      <span class="setting-label">TRABALHO <span class="setting-unit">(seg)</span></span>
      <div class="setting-control">
        <button class="setting-btn" onclick="adjustSetting('work', -5)">âˆ’</button>
        <span class="setting-value" id="valWork">20</span>
        <button class="setting-btn" onclick="adjustSetting('work', 5)">+</button>
      </div>
    </div>
    <div class="setting-row">
      <span class="setting-label">DESCANSO <span class="setting-unit">(seg)</span></span>
      <div class="setting-control">
        <button class="setting-btn" onclick="adjustSetting('rest', -5)">âˆ’</button>
        <span class="setting-value" id="valRest">10</span>
        <button class="setting-btn" onclick="adjustSetting('rest', 5)">+</button>
      </div>
    </div>
    <div class="setting-row">
      <span class="setting-label">CONTAGEM REGRESSIVA <span class="setting-unit">(seg)</span></span>
      <div class="setting-control">
        <button class="setting-btn" onclick="adjustSetting('countdown', -1)">âˆ’</button>
        <span class="setting-value" id="valCountdown">3</span>
        <button class="setting-btn" onclick="adjustSetting('countdown', 1)">+</button>
      </div>
    </div>

    <div class="toggle-row">
      <div class="toggle-label-wrap">
        <span class="setting-label">MODO MÃšSICA</span>
        <span class="toggle-sublabel">Sem som â€” sÃ³ vibraÃ§Ã£o e flash visual</span>
      </div>
      <label class="toggle">
        <input type="checkbox" id="musicMode">
        <span class="toggle-track"></span>
      </label>
    </div>
  </div>

  <div class="hint">
    Adicione Ã  Tela InÃ­cio no Safari para usar como app.<br>
    Toque em INICIAR para ativar o Ã¡udio.
  </div>
</div>

<script>
let musicMode = false;
document.getElementById('musicMode').addEventListener('change', function() {
  musicMode = this.checked;
});

const elFlash = document.getElementById('flashOverlay');
function triggerFlash(color) {
  elFlash.style.background = color;
  elFlash.classList.remove('active');
  void elFlash.offsetWidth;
  elFlash.classList.add('active');
}

let audioCtx = null;

function ensureAudio() {
  if (musicMode) return;
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
}

function playTone(freq, duration, type = 'sine', volume = 0.3) {
  if (musicMode || !audioCtx) return;
  try {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(volume, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
  } catch(e) {}
}

function vibrate(pattern) {
  if (navigator.vibrate) navigator.vibrate(pattern);
}

function notifyCountdown() {
  playTone(880, 0.15, 'sine', 0.4);
  vibrate(50);
  triggerFlash('rgba(255, 159, 10, 0.3)');
}

function notifyWorkStart() {
  playTone(1200, 0.1, 'square', 0.3);
  setTimeout(() => playTone(1500, 0.1, 'square', 0.3), 120);
  setTimeout(() => playTone(1800, 0.2, 'square', 0.4), 240);
  vibrate([100, 50, 100, 50, 100]);
  triggerFlash('rgba(255, 59, 48, 0.4)');
}

function notifyRestStart() {
  playTone(600, 0.3, 'sine', 0.3);
  vibrate([200, 100, 200]);
  triggerFlash('rgba(48, 209, 88, 0.4)');
}

function notifyFinished() {
  [0, 200, 400, 600, 800].forEach((delay, i) => {
    setTimeout(() => playTone(800 + i * 200, 0.2, 'square', 0.4), delay);
  });
  vibrate([200, 100, 200, 100, 200, 100, 400]);
  triggerFlash('rgba(255, 59, 48, 0.5)');
  setTimeout(() => triggerFlash('rgba(255, 59, 48, 0.4)'), 500);
  setTimeout(() => triggerFlash('rgba(255, 59, 48, 0.3)'), 1000);
}

let wakeLock = null;
async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      document.getElementById('wakeBadge').style.display = 'block';
      wakeLock.addEventListener('release', () => {
        document.getElementById('wakeBadge').style.display = 'none';
      });
    }
  } catch (e) {}
}
function releaseWakeLock() {
  if (wakeLock) { wakeLock.release(); wakeLock = null; }
}

const config = { sets: 8, work: 20, rest: 10, countdown: 3 };
let state = 'idle';
let currentSet = 0;
let timeLeft = 0;
let phaseDuration = 0;
let lastTick = 0;
let rafId = null;
let countdownBeeped = new Set();

const $ = id => document.getElementById(id);
const elGlow = $('glow');
const elPhase = $('phaseLabel');
const elSeconds = $('timerSeconds');
const elMs = $('timerMs');
const elDots = $('dots');
const elCurrentSeries = $('currentSeries');
const elTotalSeries = $('totalSeries');
const elBtnStart = $('btnStart');
const elBtnReset = $('btnReset');
const elSettings = $('settings');
const elRing = $('ringProgress');
const elTimerDisplay = $('timerDisplay');
const elFinished = $('finishedMsg');
const elModeBadge = $('modeBadge');

const circumference = 2 * Math.PI * 130;

function updateDisplay() {
  const secs = Math.ceil(timeLeft / 1000);
  const displaySecs = Math.max(0, secs);
  const msRaw = timeLeft % 1000;
  const displayMs = Math.max(0, Math.floor(msRaw / 10));

  elSeconds.textContent = displaySecs;
  elMs.textContent = '.' + String(displayMs).padStart(2, '0');

  const progress = phaseDuration > 0 ? 1 - (timeLeft / phaseDuration) : 0;
  elRing.style.strokeDasharray = circumference;
  elRing.style.strokeDashoffset = circumference * (1 - Math.max(0, Math.min(1, progress)));

  let color = '#333';
  let phaseClass = '';
  if (state === 'work') { color = 'var(--work)'; phaseClass = 'work'; }
  else if (state === 'rest') { color = 'var(--rest)'; phaseClass = 'rest'; }
  else if (state === 'prepare') { color = 'var(--prepare)'; phaseClass = 'prepare'; }

  elRing.style.stroke = color;
  elSeconds.style.color = state === 'idle' ? 'var(--text)' : color;

  elGlow.className = 'glow ' + (phaseClass || 'idle');
  elPhase.className = 'phase-label ' + phaseClass;

  if (state === 'work') elPhase.textContent = 'TRABALHO';
  else if (state === 'rest') elPhase.textContent = 'DESCANSO';
  else if (state === 'prepare') elPhase.textContent = 'PREPARE-SE';
  else if (state === 'finished') elPhase.textContent = 'COMPLETO!';
  else elPhase.innerHTML = '&nbsp;';

  elCurrentSeries.textContent = currentSet;
  updateDots();
}

function updateDots() {
  const dots = elDots.children;
  for (let i = 0; i < config.sets; i++) {
    const dot = dots[i];
    if (!dot) continue;
    dot.className = 'dot';
    if (i < currentSet - 1) dot.classList.add('done');
    else if (i === currentSet - 1) {
      if (state === 'work') dot.classList.add('active');
      else if (state === 'rest') dot.classList.add('rest-active');
      else dot.classList.add('done');
    }
  }
}

function buildDots() {
  elDots.innerHTML = '';
  for (let i = 0; i < config.sets; i++) {
    const d = document.createElement('div');
    d.className = 'dot';
    elDots.appendChild(d);
  }
}

function startPhase(phase, durationSec) {
  state = phase;
  timeLeft = durationSec * 1000;
  phaseDuration = durationSec * 1000;
  countdownBeeped.clear();
  lastTick = performance.now();
  updateDisplay();
}

function tick(now) {
  const delta = now - lastTick;
  lastTick = now;
  timeLeft -= delta;

  const secsLeft = Math.ceil(timeLeft / 1000);
  if (secsLeft <= config.countdown && secsLeft > 0 && !countdownBeeped.has(secsLeft)) {
    countdownBeeped.add(secsLeft);
    notifyCountdown();
    elTimerDisplay.classList.remove('pulse');
    void elTimerDisplay.offsetWidth;
    elTimerDisplay.classList.add('pulse');
  }

  if (timeLeft <= 0) {
    timeLeft = 0;
    nextPhase();
  }

  updateDisplay();

  if (state !== 'idle' && state !== 'finished') {
    rafId = requestAnimationFrame(tick);
  }
}

function nextPhase() {
  if (state === 'prepare') {
    currentSet++;
    notifyWorkStart();
    startPhase('work', config.work);
  } else if (state === 'work') {
    if (currentSet >= config.sets) {
      finish();
      return;
    }
    notifyRestStart();
    startPhase('rest', config.rest);
  } else if (state === 'rest') {
    notifyWorkStart();
    currentSet++;
    startPhase('work', config.work);
  }
}

function finish() {
  state = 'finished';
  notifyFinished();
  updateDisplay();
  elBtnStart.textContent = 'INICIAR';
  elBtnStart.classList.remove('running');
  elModeBadge.style.display = 'none';
  releaseWakeLock();
}

function startTimer() {
  if (!musicMode) ensureAudio();
  requestWakeLock();

  currentSet = 0;
  elBtnStart.style.display = 'none';
  elBtnReset.style.display = 'block';
  elSettings.style.display = 'none';
  elFinished.style.display = 'none';
  elModeBadge.style.display = musicMode ? 'block' : 'none';

  buildDots();
  startPhase('prepare', config.countdown);
  rafId = requestAnimationFrame(tick);
}

function resetTimer() {
  cancelAnimationFrame(rafId);
  state = 'idle';
  currentSet = 0;
  timeLeft = config.work * 1000;
  phaseDuration = config.work * 1000;

  elBtnStart.style.display = 'block';
  elBtnStart.textContent = 'INICIAR';
  elBtnStart.classList.remove('running');
  elBtnReset.style.display = 'none';
  elSettings.style.display = 'flex';
  elFinished.style.display = 'none';
  elModeBadge.style.display = 'none';

  buildDots();
  updateDisplay();
  releaseWakeLock();
}

function adjustSetting(key, delta) {
  const mins = { sets: 1, work: 5, rest: 5, countdown: 1 };
  const maxs = { sets: 30, work: 120, rest: 120, countdown: 10 };
  config[key] = Math.max(mins[key], Math.min(maxs[key], config[key] + delta));

  $('valSets').textContent = config.sets;
  $('valWork').textContent = config.work;
  $('valRest').textContent = config.rest;
  $('valCountdown').textContent = config.countdown;

  elTotalSeries.textContent = config.sets;
  timeLeft = config.work * 1000;
  phaseDuration = config.work * 1000;
  buildDots();
  updateDisplay();
}

elBtnStart.addEventListener('click', startTimer);
elBtnReset.addEventListener('click', resetTimer);

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && state !== 'idle' && state !== 'finished') {
    requestWakeLock();
  }
});

buildDots();
elTotalSeries.textContent = config.sets;
timeLeft = config.work * 1000;
phaseDuration = config.work * 1000;
updateDisplay();
</script>

</body>
</html>
